js_path   "/etc/nginx/njs/";
js_import https.js;
js_set $nonce_token https.readNonceToken;
js_set $session_token https.readSessionToken;
 

  server {
    include                     /etc/nginx/conf.d/timeout.conf;
    listen                      443 ssl http2;
    listen                      [::]:443 ssl http2;
    error_page 497 https://$host:$server_port$request_uri;
    server_name                 xyz.vzbuilders.com;
    ssl_certificate             /etc/nginx/ssl/rpaproxy.crt;
    ssl_certificate_key         /etc/nginx/ssl/rpaproxy.key;




  # Additional Settings for Proxy timeout
        underscores_in_headers on;
        sendfile                    on;
        tcp_nopush                  on;
        tcp_nodelay                 on;
        #keepalive_timeout           180;
        #proxy_connect_timeout       300;
        #proxy_read_timeout          300;
        types_hash_max_size 2048;
#Client Upload limit
        client_max_body_size 100m;
        ssl_session_timeout         1d;
        ssl_session_cache                       shared:SSL:50m;
        ssl_session_tickets             off;
        ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers                'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';
        ssl_prefer_server_ciphers   on;

    # HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)
    add_header Strict-Transport-Security max-age=15768000;

        # Optional optimisation - please refer to http://nginx.org/en/docs/http/configuring_https_servers.html
        # ssl_session_cache   shared:SSL:10m;

            # OCSP Stapling ---
            # fetch OCSP records from URL in ssl_certificate and cache them
            ssl_stapling on;
            ssl_stapling_verify on;


   location /akamai {
      return 200 'OK';
      add_header Content-Type text/plain;
   }


   location /hello {
       js_content    https.hello;
   #    #resolver     8.8.8.8;
   #    #proxy_pass   https://xyz.verizonmedia.com:443;
   #    #try_files    $uri @rpaproxy_auth;
   }

   location /api_nonce {
       proxy_method          GET;
       proxy_pass            https://xyz.verizonmedia.com/seal-ws/v5/security/nonce;
       proxy_redirect        off;
   }
 
   location /session_auth {
      proxy_method          POST;
      add_header            Content-Type "application/json"; 
      proxy_set_header      Content-Type "application/json"; 
      proxy_pass            https://xyz.verizonmedia.com/seal-ws/v5/auths;
   }
       
   location /auth {
      #resolver                 8.8.8.8; 
      #proxy_pass               https://xyz.verizonmedia.com:443;
      js_content                https.nonce;
      #proxy_pass_request_body   on;
      #proxy_set_header         X-Forwarded-Host $host;
      #proxy_set_header         X-Forwarded-Server $host;
      #proxy_set_header         X-Forwarded-For $proxy_add_x_forwarded_for;
      #proxy_set_header          X-Real-IP $remote_addr;
      #proxy_redirect            on;
      #proxy_pass               https://xyz.verizonmedia.com:443/seal-ws/v5/security/nonce;
      #try_files                $uri @rpaproxy_login;
    }
   
   location /session {
      add_header            Content-Type "application/json";
      js_content            https.session;
   }
   
   location ~* ^/contract/(.*) {
      proxy_method         GET;
      add_header           X-Session-Token $session_token;
      proxy_set_header     X-Session-Token $session_token;
      proxy_pass           https://xyz.verizonmedia.com:443/seal-ws/v5/contracts?metadata&limit=10&q=$1&fq=&timeAllowed=;
   }   
  
   location /documents {
     proxy_method                   POST;
     add_header                     X-Session-Token $session_token;
     proxy_set_header               X-Session-Token $session_token;
     client_body_in_file_only       on;
     client_body_buffer_size        128K;
     client_max_body_size           20G;
     proxy_pass                     https://xyz.verizonmedia.com:443/seal-ws/v5/documents;
  }
    #location @rpaproxy_login {
    #    proxy_set_header        Content-Type: "application/json";
    #    proxy_set_body          "principal=

  location /nginx_status {
       # Turn on stats
        stub_status on;
        access_log   off;
        # only allow access from 1.1.1.1 #
        allow 1.1.1.1;
        deny all;
   }
 }
